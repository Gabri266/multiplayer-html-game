<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Multiplayer Game</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <style>
    body {
      margin: 0; padding: 0;
      background: #000; color: #fff;
      font-family: sans-serif;
      touch-action: none;
      -ms-touch-action: none;
    }
    canvas {
      display: block;
      margin: 20px auto 0;
      background: #222;
      border: 2px solid #fff;
      touch-action: none;
    }
    #ui {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      margin-top: 10px;
      gap: 10px;
    }
    button {
      padding: 15px 20px;
      font-size: 18px;
      background: #444;
      color: white;
      border: none;
      border-radius: 8px;
      touch-action: manipulation;
      user-select: none;
    }
    #respawnBtn {
      display: none;
      margin: 10px auto;
      cursor: pointer;
    }
  </style>
</head>
<body>

<canvas id="game" width="600" height="400"></canvas>
<div id="ui">
  <button onclick="move('ArrowLeft')">◀</button>
  <button onclick="move('ArrowUp')">▲</button>
  <button onclick="move('ArrowDown')">▼</button>
  <button onclick="move('ArrowRight')">▶</button>
</div>
<button id="respawnBtn" onclick="respawn()">Respawna</button>

<script src="https://cdn.pubnub.com/sdk/javascript/pubnub.4.37.0.min.js"></script>
<script>
  const pubnub = new PubNub({
    publishKey: 'pub-c-586ffd5d-1b7f-4c3a-a826-033aa2ce3b21',
    subscribeKey: 'sub-c-7deb358a-4a16-4868-9a20-fbeec203708b',
    uuid: 'player-' + Date.now()
  });

  const channel = "game-channel";
  const canvas = document.getElementById('game');
  const ctx = canvas.getContext('2d');
  const myID = pubnub.getUUID();

  let players = {};
  let bullets = [];
  let isDead = false;
  
  // Tiene traccia dei colpi per bersaglio {targetId: hitsCount}
  let hitCounts = {};

  players[myID] = {
    x: Math.random() * 580,
    y: Math.random() * 380,
    color: '#' + Math.floor(Math.random() * 16777215).toString(16),
    kills: 0,
    lives: 3,
  };

  function move(key) {
    if (isDead) return;
    const dirs = {
      ArrowLeft: { dx: -5, dy: 0 },
      ArrowRight: { dx: +5, dy: 0 },
      ArrowUp: { dx: 0, dy: -5 },
      ArrowDown: { dx: 0, dy: +5 }
    };
    const dir = dirs[key];
    if (dir) {
      let me = players[myID];
      me.x = Math.max(0, Math.min(580, me.x + dir.dx));
      me.y = Math.max(0, Math.min(380, me.y + dir.dy));
      sendState();
    }
  }
  document.addEventListener('keydown', e => move(e.key));
  window.move = move;

  canvas.addEventListener('click', e => {
    if (isDead) return;
    const rect = canvas.getBoundingClientRect();
    const tx = e.clientX - rect.left;
    const ty = e.clientY - rect.top;
    const me = players[myID];
    bullets.push({
      id: myID + "-" + Date.now(),
      x: me.x + 10,
      y: me.y + 10,
      tx, ty,
      owner: myID,
      start: Date.now()
    });
    sendBullets();
  });

  function sendState() {
    pubnub.publish({
      channel,
      message: {
        type: 'state',
        uuid: myID,
        data: players[myID]
      }
    });
  }

  function sendBullets() {
    pubnub.publish({
      channel,
      message: {
        type: 'bullets',
        bullets: bullets
      }
    });
  }

  pubnub.addListener({
    message: ({ message }) => {
      if (message.type === 'state') {
        players[message.uuid] = {
          ...players[message.uuid],
          ...message.data
        };
      } else if (message.type === 'bullets') {
        bullets = message.bullets;
      } else if (message.type === 'hit') {
        if (message.uuid === myID) {
          players[myID].lives--;
          if (players[myID].lives <= 0) die();
        } else if (players[message.uuid]) {
          players[message.uuid].lives--;
          if (players[message.uuid].lives <= 0) {
            players[message.uuid].lives = 3; // reset vite per altri (semplificato)
          }
        }
      } else if (message.type === 'kill') {
        if (message.uuid === myID) {
          players[myID].kills++;
          sendState();
        }
      } else if (message.type === 'leave') {
        delete players[message.uuid];
      }
    }
  });
  pubnub.subscribe({ channels: [channel] });

  function die() {
    isDead = true;
    // Mostra bottone respawn
    document.getElementById('respawnBtn').style.display = 'block';
    sendState();
  }

  function respawn() {
    if (!isDead) return;
    players[myID].x = Math.random() * 580;
    players[myID].y = Math.random() * 380;
    players[myID].lives = 3;
    isDead = false;
    hitCounts = {};
    document.getElementById('respawnBtn').style.display = 'none';
    sendState();
  }

  function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    const me = players[myID];
    if (me) {
      let hearts = '';
      for(let i=0; i<3; i++) {
        hearts += i < me.lives ? '❤️' : '🖤';
      }
      ctx.fillStyle = 'white';
      ctx.font = '20px sans-serif';
      ctx.fillText(hearts + '  Kill: ' + (me.kills || 0), 10, 25);
    }

    for (let id in players) {
      if (id === myID && isDead) continue;
      const p = players[id];
      if (p.lives <= 0) continue;
      ctx.fillStyle = p.color;
      ctx.fillRect(p.x, p.y, 20, 20);
      if (id === myID) {
        ctx.fillStyle = "white";
        ctx.font = "12px sans-serif";
        ctx.fillText("You", p.x, p.y - 5);
      }
    }

    const now = Date.now();
    bullets = bullets.filter(b => now - b.start < 3000);
    bullets.forEach((b, i) => {
      const speed = 5;
      const dx = b.tx - b.x;
      const dy = b.ty - b.y;
      const dist = Math.sqrt(dx*dx + dy*dy);
      if(dist > 0) {
        b.x += (dx / dist) * speed;
        b.y += (dy / dist) * speed;
      }

      ctx.fillStyle = 'yellow';
      ctx.beginPath();
      ctx.arc(b.x, b.y, 5, 0, 2 * Math.PI);
      ctx.fill();

      for (let id in players) {
        if (id === b.owner) continue;
        const p = players[id];
        if (p.lives <= 0) continue;
        if (b.x > p.x && b.x < p.x + 20 && b.y > p.y && b.y < p.y + 20) {
          // Conta i colpi
          if (!hitCounts[b.owner]) hitCounts[b.owner] = {};
          if (!hitCounts[b.owner][id]) hitCounts[b.owner][id] = 0;
          hitCounts[b.owner][id]++;

          pubnub.publish({ channel, message: { type: 'hit', uuid: id } });

          // Se colpito 3 volte, kill per owner
          if (hitCounts[b.owner][id] >= 3) {
            pubnub.publish({ channel, message: { type: 'kill', uuid: b.owner } });
            hitCounts[b.owner][id] = 0; // reset contatore
          }

          bullets.splice(i, 1);
          sendBullets();
          break;
        }
      }
    });

    if (isDead) {
      ctx.fillStyle = "red";
      ctx.font = "40px sans-serif";
      ctx.fillText("SEI MORTO", canvas.width/2 - 120, canvas.height/2);
    }

    requestAnimationFrame(draw);
  }

  draw();

  window.addEventListener('beforeunload', () => {
    pubnub.publish({ channel, message: { type: 'leave', uuid: myID } });
  });
</script>

</body>
</html>
