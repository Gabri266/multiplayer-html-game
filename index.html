<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Multiplayer Game</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <style>
    body {
      margin: 0; padding: 0;
      background: #000; color: #fff;
      font-family: sans-serif;
      touch-action: none;
    }
    canvas {
      display: block;
      margin: 20px auto 0;
      background: #222;
      border: 2px solid #fff;
    }
    #ui {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      margin-top: 10px;
      gap: 10px;
      user-select: none;
      -webkit-user-select: none;
      -ms-user-select: none;
      touch-action: manipulation;
    }
    button {
      padding: 15px 20px;
      font-size: 18px;
      background: #444;
      color: white;
      border: none;
      border-radius: 8px;
      touch-action: manipulation;
      user-select: none;
      -webkit-user-select: none;
      -ms-user-select: none;
    }
    #respawnBtn {
      display: none;
      position: absolute;
      top: 55%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: red;
      font-size: 24px;
      padding: 15px 30px;
      border-radius: 10px;
      cursor: pointer;
      user-select: none;
    }
    #nameInput {
      position: absolute;
      top: 40%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 10;
      text-align: center;
      user-select: none;
    }
    #nameInput input {
      font-size: 24px;
      padding: 10px;
      border-radius: 8px;
      width: 200px;
      user-select: text;
    }
    #nameInput button {
      margin-top: 10px;
      font-size: 20px;
      cursor: pointer;
    }
  </style>
</head>
<body>

<div id="nameInput">
  <input type="text" id="playerName" placeholder="Inserisci il tuo nome" autocomplete="off" autocorrect="off" autocapitalize="off" />
  <br />
  <button onclick="startGame()">Entra nel gioco</button>
</div>

<canvas id="game" width="600" height="400"></canvas>

<div id="ui">
  <button onclick="move('ArrowLeft')">◀</button>
  <button onclick="move('ArrowUp')">▲</button>
  <button onclick="move('ArrowDown')">▼</button>
  <button onclick="move('ArrowRight')">▶</button>
</div>

<button id="respawnBtn" onclick="respawn()">RESPAWNA</button>

<script src="https://cdn.pubnub.com/sdk/javascript/pubnub.4.37.0.min.js"></script>
<script>
  // Gestione UUID persistente (evita che cambi ad ogni reload)
  let storedUUID = localStorage.getItem('playerUUID');
  if (!storedUUID) {
    storedUUID = 'player-' + Date.now();
    localStorage.setItem('playerUUID', storedUUID);
  }

  const pubnub = new PubNub({
    publishKey: 'pub-c-586ffd5d-1b7f-4c3a-a826-033aa2ce3b21',
    subscribeKey: 'sub-c-7deb358a-4a16-4868-9a20-fbeec203708b',
    uuid: storedUUID
  });

  const channel = "game-channel";
  const canvas = document.getElementById('game');
  const ctx = canvas.getContext('2d');
  const myID = pubnub.getUUID();

  let players = {};
  let bullets = [];
  let isDead = false;
  let lastShotTime = 0;
  const respawnBtn = document.getElementById("respawnBtn");

  // Funzione di inizio gioco, crea player con nome e posizione random
  function startGame() {
    const name = document.getElementById("playerName").value.trim();
    if (!name) return alert("Inserisci un nome!");

    players[myID] = {
      name: name,
      x: Math.random() * 580,
      y: Math.random() * 380,
      color: '#' + Math.floor(Math.random() * 16777215).toString(16),
      kills: 0,
      lives: 3,
      hits: 0
    };

    document.getElementById("nameInput").style.display = "none";
    sendState();
    draw();
  }

  // Movimento con limiti mappa 600x400
  function move(key) {
    if (isDead || !players[myID]) return;
    const dirs = {
      ArrowLeft: { dx: -5, dy: 0 },
      ArrowRight: { dx: +5, dy: 0 },
      ArrowUp: { dx: 0, dy: -5 },
      ArrowDown: { dx: 0, dy: +5 }
    };
    const dir = dirs[key];
    if (dir) {
      let me = players[myID];
      me.x = Math.max(0, Math.min(580, me.x + dir.dx));
      me.y = Math.max(0, Math.min(380, me.y + dir.dy));
      sendState();
    }
  }
  // Supporto tastiera
  document.addEventListener('keydown', e => move(e.key));
  window.move = move;  // esporta per i pulsanti mobile

  // Sparo con cooldown 1 secondo
  canvas.addEventListener('click', e => {
    if (isDead || !players[myID]) return;
    const now = Date.now();
    if (now - lastShotTime < 1000) return;
    lastShotTime = now;

    const rect = canvas.getBoundingClientRect();
    const tx = e.clientX - rect.left;
    const ty = e.clientY - rect.top;
    const me = players[myID];
    const bullet = {
      id: myID + "-" + now,
      x: me.x + 10,
      y: me.y + 10,
      tx, ty,
      owner: myID,
      start: now
    };
    bullets.push(bullet);
    sendBullets();
  });

  // Pubblica stato player
  function sendState() {
    pubnub.publish({
      channel,
      message: {
        type: 'state',
        uuid: myID,
        data: players[myID]
      }
    });
  }
  // Pubblica proiettili
  function sendBullets() {
    pubnub.publish({
      channel,
      message: {
        type: 'bullets',
        bullets: bullets
      }
    });
  }

  pubnub.addListener({
    message: ({ message }) => {
      if (message.type === 'state') {
        players[message.uuid] = {
          ...players[message.uuid],
          ...message.data
        };
      } else if (message.type === 'bullets') {
        bullets = message.bullets;
      } else if (message.type === 'hit') {
        if (!players[message.uuid]) return;
        // Ogni hit toglie 1 vita
        players[message.uuid].lives--;

        // Se vita <= 0 e sei tu che sei stato colpito, muori
        if (players[message.uuid].lives <= 0) {
          players[message.uuid].lives = 0;
          if (message.uuid === myID) die();
        }
      } else if (message.type === 'kill') {
        if (message.uuid === myID && players[myID]) {
          players[myID].kills++;
          sendState();
        }
      } else if (message.type === 'leave') {
        delete players[message.uuid];
      }
    }
  });

  pubnub.subscribe({ channels: [channel] });

  // Funzione morte
  function die() {
    isDead = true;
    respawnBtn.style.display = 'block';
  }

  // Pulsante respawn
  function respawn() {
    players[myID].x = Math.random() * 580;
    players[myID].y = Math.random() * 380;
    players[myID].lives = 3;
    isDead = false;
    respawnBtn.style.display = 'none';
    sendState();
  }

  // Disegna tutto
  function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    // Cuori e kill in alto a sinistra solo per me
    const me = players[myID];
    if (me) {
      let hearts = '';
      for (let i = 0; i < 3; i++) {
        hearts += i < me.lives ? '❤️' : '🖤';
      }
      ctx.fillStyle = 'white';
      ctx.font = '20px sans-serif';
      ctx.fillText(hearts + '  Kill: ' + (me.kills || 0), 10, 25);
    }

    // Disegna player (non morto)
    for (let id in players) {
      if (id === myID && isDead) continue;
      const p = players[id];
      ctx.fillStyle = p.color;
      ctx.fillRect(p.x, p.y, 20, 20);
      ctx.fillStyle = "white";
      ctx.font = "12px sans-serif";
      ctx.fillText(p.name || "Player", p.x, p.y - 5);
    }

    // Muovi e disegna proiettili
    const now = Date.now();
    bullets = bullets.filter(b => now - b.start < 3000);
    bullets.forEach((b, i) => {
      const speed = 5;
      const dx = b.tx - b.x;
      const dy = b.ty - b.y;
      const dist = Math.sqrt(dx * dx + dy * dy);
      if (dist > 0) {
        b.x += (dx / dist) * speed;
        b.y += (dy / dist) * speed;
      }

      ctx.fillStyle = 'yellow';
      ctx.beginPath();
      ctx.arc(b.x, b.y, 5, 0, 2 * Math.PI);
      ctx.fill();

      for (let id in players) {
        if (id === b.owner || players[id].lives <= 0) continue;
        let p = players[id];
        if (b.x > p.x && b.x < p.x + 20 && b.y > p.y && b.y < p.y + 20) {
          // Mando messaggio hit (toglie 1 vita)
          pubnub.publish({ channel, message: { type: 'hit', uuid: id } });

          // Se la vita era 1 (cioè ora si azzera) e sei il tiratore, mando la kill
          if (p.lives === 1 && b.owner === myID) {
            pubnub.publish({ channel, message: { type: 'kill', uuid: myID } });
          }

          bullets.splice(i, 1);
          sendBullets();
          break;
        }
      }
    });

    // Classifica globale in alto a destra
    const sorted = Object.values(players).sort((a, b) => (b.kills || 0) - (a.kills || 0));
    ctx.fillStyle = 'white';
    ctx.font = '16px sans-serif';
    sorted.forEach((p, i) => {
      ctx.fillText(`${p.name || 'Anon'}: ${p.kills || 0}`, canvas.width - 150, 25 + i * 20);
    });

    if (isDead) {
      ctx.fillStyle = "red";
      ctx.font = "40px sans-serif";
      ctx.fillText("SEI MORTO", canvas.width / 2 - 120, canvas.height / 2);
    }

    requestAnimationFrame(draw);
  }

  // Quando chiudo pagina avviso tutti che esco
  window.addEventListener('beforeunload', () => {
    pubnub.publish({ channel, message: { type: 'leave', uuid: myID } });
  });
</script>
</body>
</html>
