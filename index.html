<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Gioco Multiplayer con PubNub</title>
  <style>
    body { background: #000; color: #fff; text-align: center; font-family: sans-serif; }
    canvas { background: #222; display: block; margin: 20px auto; border: 2px solid #fff; touch-action: none; }
    #hearts {
      position: fixed; top: 10px; right: 20px;
      font-size: 30px; color: red; z-index: 100;
    }
    .button {
      position: fixed; bottom: 20px; font-size: 20px;
      background: #444; color: white; padding: 10px;
      border-radius: 5px;
    }
    #left  { left: 20px; }
    #right { left: 100px; }
    #up    { left: 60px; bottom: 80px; }
    #down  { left: 60px; bottom: -20px; }
  </style>
</head>
<body>
  <h1>Gioco Multiplayer (HTML + JS + PubNub)</h1>
  <div id="hearts">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div>
  <canvas id="game" width="600" height="400"></canvas>

  <div class="button" id="left">‚óÄ</div>
  <div class="button" id="right">‚ñ∂</div>
  <div class="button" id="up">‚ñ≤</div>
  <div class="button" id="down">‚ñº</div>

  <script src="https://cdn.pubnub.com/sdk/javascript/pubnub.4.37.0.min.js"></script>
  <script>
    const pubnub = new PubNub({
      publishKey:   'pub-c-586ffd5d-1b7f-4c3a-a826-033aa2ce3b21',
      subscribeKey: 'sub-c-7deb358a-4a16-4868-9a20-fbeec203708b',
      uuid:         'player-' + Date.now()
    });

    const channel = "game-channel";
    const canvas = document.getElementById('game');
    const ctx    = canvas.getContext('2d');
    const myID   = pubnub.getUUID();
    let players  = {};
    let bullets  = [];
    let myLives  = 3;

    // Posizione iniziale e colore
    players[myID] = {
      x: Math.random()*580,
      y: Math.random()*380,
      color: '#' + Math.floor(Math.random()*16777215).toString(16)
    };

    updateHearts();

    // Mobile controls
    const dirs = {
      left:  { dx: -5, dy: 0 },
      right: { dx: +5, dy: 0 },
      up:    { dx: 0,  dy: -5 },
      down:  { dx: 0,  dy: +5 }
    };
    for (let dir in dirs) {
      document.getElementById(dir).addEventListener('touchstart', () => move(dirs[dir]));
    }

    // Tastiera
    document.addEventListener('keydown', e => {
      const mappa = {
        ArrowLeft: dirs.left,
        ArrowRight: dirs.right,
        ArrowUp: dirs.up,
        ArrowDown: dirs.down
      };
      if (mappa[e.key]) move(mappa[e.key]);
    });

    function move(dir) {
      let me = players[myID];
      me.x = Math.max(0, Math.min(580, me.x + dir.dx));
      me.y = Math.max(0, Math.min(380, me.y + dir.dy));
      sendMove();
    }

    function sendMove() {
      pubnub.publish({
        channel,
        message: {
          type: 'move',
          uuid: myID,
          data: players[myID]
        }
      });
    }

    canvas.addEventListener('click', e => {
      const rect = canvas.getBoundingClientRect();
      const tx = e.clientX - rect.left;
      const ty = e.clientY - rect.top;
      bullets.push({ x: players[myID].x+10, y: players[myID].y+10, tx, ty, owner: myID });
    });

    // Ricevi messaggi
    pubnub.addListener({
      message: ({ message }) => {
        const { type, uuid, data, target } = message;

        if (type === 'move') {
          players[uuid] = data;
        } else if (type === 'hit' && uuid === myID) {
          myLives = Math.max(0, myLives - 1);
          updateHearts();
        } else if (type === 'leave') {
          delete players[uuid];
        }
      }
    });
    pubnub.subscribe({ channels: [channel] });
    sendMove();

    function updateHearts() {
      document.getElementById('hearts').innerHTML = '‚ù§Ô∏è'.repeat(myLives) + 'üñ§'.repeat(3 - myLives);
    }

    function draw() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      // Giocatori
      for (let id in players) {
        let p = players[id];
        ctx.fillStyle = p.color;
        ctx.fillRect(p.x, p.y, 20, 20);
      }

      // Proiettili
      bullets.forEach((b, i) => {
        const speed = 6;
        const dx = b.tx - b.x;
        const dy = b.ty - b.y;
        const dist = Math.sqrt(dx*dx + dy*dy);
        b.x += (dx/dist)*speed;
        b.y += (dy/dist)*speed;

        ctx.fillStyle = 'yellow';
        ctx.beginPath();
        ctx.arc(b.x, b.y, 5, 0, 2 * Math.PI);
        ctx.fill();

        for (let id in players) {
          if (id !== b.owner) {
            let p = players[id];
            if (b.x > p.x && b.x < p.x+20 && b.y > p.y && b.y < p.y+20) {
              pubnub.publish({
                channel,
                message: { type: 'hit', uuid: id }
              });
              bullets.splice(i, 1);
              break;
            }
          }
        }

        if (b.x < 0 || b.x > 600 || b.y < 0 || b.y > 400) {
          bullets.splice(i, 1);
        }
      });

      requestAnimationFrame(draw);
    }

    draw();

    // Cancella giocatore se esce
    window.addEventListener('beforeunload', () => {
      pubnub.publish({ channel, message: { type: 'leave', uuid: myID } });
    });
  </script>
</body>
</html>
