<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Gioco Multiplayer con PubNub</title>
  <style>
    body { background: #000; color: #fff; text-align: center; font-family: sans-serif; }
    canvas { background: #222; display: block; margin: 20px auto; border: 2px solid #fff; }
  </style>
</head>
<body>
  <h1>Gioco Multiplayer (HTML + JS + PubNub)</h1>
  <canvas id="game" width="600" height="400"></canvas>

  <!-- 1) Includi PubNub -->
  <script src="https://cdn.pubnub.com/sdk/javascript/pubnub.4.37.0.min.js"></script>
  <script>
    // 2) Inizializza PubNub
    const pubnub = new PubNub({
      publishKey:   'pub-c-586ffd5d-1b7f-4c3a-a826-033aa2ce3b21',
      subscribeKey: 'sub-c-7deb358a-4a16-4868-9a20-fbeec203708b',
      uuid:         'player-' + Date.now()
    });

    const channel = "game-channel";
    const canvas = document.getElementById('game');
    const ctx    = canvas.getContext('2d');
    let players  = {};

    // 3) Quando arriva un messaggio, aggiorniamo posizioni
    pubnub.addListener({
      message: m => {
        players = m.message;
        draw();
      }
    });
    pubnub.subscribe({ channels: [channel] });

    // 4) Genera il tuo personaggio
    const me = {
      x: Math.random()*580 + 10,
      y: Math.random()*380 + 10,
      color: '#' + Math.floor(Math.random()*16777215).toString(16)
    };
    players[pubnub.getUUID()] = me;
    publish();

    // 5) Pubblica la posizione a ogni mossa
    document.addEventListener('keydown', e => {
      const dirs = {
        ArrowLeft: { dx: -5, dy:  0 },
        ArrowRight:{ dx: +5, dy:  0 },
        ArrowUp:   { dx:  0, dy: -5 },
        ArrowDown: { dx:  0, dy: +5 }
      };
      if (dirs[e.key]) {
        me.x += dirs[e.key].dx;
        me.y += dirs[e.key].dy;
        players[pubnub.getUUID()] = me;
        publish();
      }
    });

    // 6) Funzione per inviare lo stato di tutti i giocatori
    function publish() {
      pubnub.publish({
        channel: channel,
        message: players
      });
    }

    // 7) Disegna tutto
    function draw() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      for (let id in players) {
        const p = players[id];
        ctx.fillStyle = p.color;
        ctx.fillRect(p.x, p.y, 20, 20);
      }
    }

    // 8) Pulisci alla chiusura
    window.addEventListener('beforeunload', () => {
      delete players[pubnub.getUUID()];
      publish();
    });
  </script>
</body>
</html>
